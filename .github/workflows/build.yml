name: Build and Obfuscate BPB Panel

on:
  push:
    branches:
      - main
  schedule:
    # 每天凌晨1:00运行
    - cron: "0 1 * * *"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置 Node.js 环境
        uses: actions/setup-node@v4
        with:
          node-version: "latest"

      - name: 安装依赖项
        run: |
          # 锁定 obfuscator 版本，保证混淆结果长期稳定
          npm install -g javascript-obfuscator@4.1.0

      - name: 下载 BPB worker.js（自动抓取最新 Release）
        run: |
          REPO="bia-pain-bache/BPB-Worker-Panel"
          ASSET_NAME="worker.js"

          echo "开始抓取最新 Release..."

          # 使用 GitHub API 获取最新 Release 版本下载地址
          PRIMARY_URL=$(curl -s "https://api.github.com/repos/$REPO/releases/latest" \
            | grep "browser_download_url" \
            | grep "$ASSET_NAME" \
            | cut -d '"' -f 4)

          echo "抓取到最新 Release 地址: $PRIMARY_URL"

          # 备用URL列表
          FALLBACK_URLS=(
            "https://raw.githubusercontent.com/bia-pain-bache/BPB-Worker-Panel/main/build/unobfuscated-worker.js"
            "https://cdn.jsdelivr.net/gh/bia-pain-bache/BPB-Worker-Panel@main/build/unobfuscated-worker.js"
            "https://ghproxy.com/https://raw.githubusercontent.com/bia-pain-bache/BPB-Worker-Panel/main/build/unobfuscated-worker.js"
          )

          echo "开始下载 BPB worker.js 文件..."

          # 尝试主 URL
          if [ -n "$PRIMARY_URL" ] && wget -O origin.js "$PRIMARY_URL"; then
            echo "✅ Releases URL 下载成功"
          else
            echo "Releases 下载失败，尝试备用 URL..."
            SUCCESS=false
            for url in "${FALLBACK_URLS[@]}"; do
              echo "尝试: $url"
              if wget -O origin.js "$url"; then
                echo "✅ 备用 URL 下载成功: $url"
                SUCCESS=true
                break
              fi
            done
            if [ "$SUCCESS" = false ] || [ ! -f origin.js ] || [ ! -s origin.js ]; then
              echo "❌ 所有下载源失败，任务中止"
              exit 1
            fi
          fi

          echo "下载完成: $(wc -c < origin.js) 字节"

      - name: 一阶段预混淆（结构扰动层）
        run: |
          echo "开始第一阶段预混淆..."

          javascript-obfuscator origin.js --output stage1.js \
            --compact false \
            --dead-code-injection true \
            --dead-code-injection-threshold 0.2 \
            --string-array true \
            --string-array-threshold 1 \
            --string-array-encoding none \
            --string-array-index-shift true \
            --identifier-names-generator hexadecimal \
            --unicode-escape-sequence false \
            --seed 9527

          echo "一阶段完成: $(wc -c < stage1.js) 字节"

      - name: 二阶段企业级深度混淆（主混淆层）
        run: |
          echo "开始第二阶段企业级混淆..."

          javascript-obfuscator stage1.js --output _worker.js \
            --compact true \
            --control-flow-flattening true \
            --control-flow-flattening-threshold 0.9 \
            --dead-code-injection false \
            --identifier-names-generator mangled \
            --rename-globals false \
            --string-array true \
            --string-array-encoding 'rc4' \
            --string-array-threshold 1 \
            --string-array-index-shift true \
            --transform-object-keys true \
            --numbers-to-expressions true \
            --unicode-escape-sequence true \
            --target 'node' \
            --seed 9527

          echo "二阶段完成，最终文件大小: $(wc -c < _worker.js) 字节"

      - name: 提交更改
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          branch: main
          commit_message: ':rocket: 企业级混淆 + BPB 最新构建自动更新'
          commit_author: 'github-actions[bot] <github-actions[bot]@users.noreply.github.com>'
          push_options: '--set-upstream'
