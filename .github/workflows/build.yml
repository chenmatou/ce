name: Deploy BPB Panel

on:
  push:
    branches:
      - main
  schedule:
    - cron: "0 1 * * *" # 每天自动更新
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 下载官方纯净版代码
        run: |
          # 强制下载官方 Release 版本，确保 100% 稳定
          DOWNLOAD_URL="https://github.com/bia-pain-bache/BPB-Worker-Panel/releases/latest/download/worker.js"
          
          echo "正在从 $DOWNLOAD_URL 下载..."
          
          if wget -O _worker.js -L "$DOWNLOAD_URL"; then
            echo "✅ 代码下载成功"
          else
            echo "❌ 下载失败"
            exit 1
          fi

          # 简单校验
          if [ $(wc -c < _worker.js) -lt 1000 ]; then
             echo "❌ 文件太小，可能是无效文件"
             exit 1
          fi

      - name: 清理垃圾文件
        run: |
          # 删除以前可能存在的混淆文件，保持仓库干净
          rm -f origin.js stage1.js

      - name: 提交并推送
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          branch: main
          commit_message: 'Deploy: 更新纯净版 _worker.js'
          commit_author: 'github-actions[bot] <github-actions[bot]@users.noreply.github.com>'
          push_options: '--set-upstream'
