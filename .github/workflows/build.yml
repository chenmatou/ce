name: Stable BPB with Health Patch (No Obfuscation)

on:
  push:
    branches:
      - main
  schedule:
    # æ¯å¤©å‡Œæ™¨1:00è¿è¡Œ
    - cron: "0 1 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      # è¿™ä¸€æ­¥åªä¸ºäº†ä¸‹è½½æ–‡ä»¶ï¼Œä¸éœ€è¦ Node ç¯å¢ƒå’Œæ··æ·†å·¥å…·äº†
      # æé€Ÿæ„å»º

      - name: ğŸ“¥ ä¸‹è½½å®˜æ–¹ BPB worker.js
        run: |
          # åŠ¨æ€è·å–æœ€æ–° Release çš„ä¸‹è½½åœ°å€
          REPO="bia-pain-bache/BPB-Worker-Panel"
          PRIMARY_URL=$(curl -s "https://api.github.com/repos/$REPO/releases/latest" | grep "browser_download_url" | grep "worker.js" | cut -d '"' -f 4)
          
          # å¤‡ç”¨URL (æºç ç‰ˆ)
          FALLBACK_URLS=(
            "https://raw.githubusercontent.com/bia-pain-bache/BPB-Worker-Panel/main/build/unobfuscated-worker.js"
            "https://cdn.jsdelivr.net/gh/bia-pain-bache/BPB-Worker-Panel@main/build/unobfuscated-worker.js"
          )
          
          echo "æ­£åœ¨ä¸‹è½½æœ€æ–°ç‰ˆä»£ç ..."
          
          # ä¸‹è½½é€»è¾‘
          if [ -n "$PRIMARY_URL" ] && wget -O origin.js "$PRIMARY_URL"; then
            echo "âœ… Release ç‰ˆæœ¬ä¸‹è½½æˆåŠŸ"
          else
            echo "âš ï¸ Release ä¸‹è½½å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨åœ°å€..."
            SUCCESS=false
            for url in "${FALLBACK_URLS[@]}"; do
              if wget -O origin.js "$url"; then
                echo "âœ… å¤‡ç”¨åœ°å€ä¸‹è½½æˆåŠŸ"
                SUCCESS=true
                break
              fi
            done
            if [ "$SUCCESS" = false ] || [ ! -s origin.js ]; then
              echo "âŒ ä¸‹è½½å¤±è´¥"
              exit 1
            fi
          fi

      - name: ğŸ’‰ æ³¨å…¥èŠ‚ç‚¹å¥åº·æ£€æŸ¥è¡¥ä¸ (çœŸè¿æ¥+100%ç¨³å®š)
        run: |
          echo "æ­£åœ¨æ³¨å…¥å¥åº·æ£€æŸ¥é€»è¾‘..."
          
          # 1. ç”Ÿæˆè¡¥ä¸æ–‡ä»¶ (è¿™æ˜¯ä½ æä¾›çš„ä¼˜åŒ–ä»£ç )
          cat > health_patch.js << 'EOF'
          // ====== èŠ‚ç‚¹å¥åº·æ£€æŸ¥è¡¥ä¸ (æ— æ··æ·†æ³¨å…¥ç‰ˆ) ======
          // åŠŸèƒ½ï¼šçœŸè¿æ¥éªŒè¯ + ç¨³å®šæ€§100% + é«˜å»¶è¿Ÿç­›é€‰
          
          (function() {
            'use strict';
            const HEALTH_CONFIG = {
              STABILITY: 1.0,          // ç¨³å®šæ€§è¦æ±‚100%
              MAX_LATENCY: 150,        // åªé€‰ä½å»¶è¿Ÿ
              CHECK_TIMEOUT: 5000,
              REQUIRED_TESTS: 3
            };
            
            class NodeHealthChecker {
              constructor() {
                this.healthyNodes = new Map();
              }
              
              async verifyRealConnection(node) {
                const startTime = Date.now();
                try {
                  const controller = new AbortController();
                  const timeoutId = setTimeout(() => controller.abort(), HEALTH_CONFIG.CHECK_TIMEOUT);
                  const response = await fetch(node.url, {
                    method: 'HEAD',
                    mode: 'no-cors',
                    signal: controller.signal,
                    headers: { 'User-Agent': 'HealthCheck/1.0', 'Cache-Control': 'no-cache' }
                  });
                  clearTimeout(timeoutId);
                  const latency = Date.now() - startTime;
                  // ç®€å•çš„éªŒè¯é€»è¾‘
                  if (latency > HEALTH_CONFIG.MAX_LATENCY || latency < 1) return { healthy: false };
                  return { healthy: true, latency: latency };
                } catch (e) {
                  return { healthy: false, error: e.message };
                }
              }
              
              // è¿™é‡Œçš„é€»è¾‘ä¼šæ ¹æ® BPB é¢æ¿çš„å…·ä½“å®ç°è‡ªåŠ¨æŒ‚è½½
              // æ­¤è¡¥ä¸ä¸»è¦ä½œç”¨æ˜¯å£°æ˜å…¨å±€æ£€æµ‹å™¨
            }
            
            if (typeof globalThis !== 'undefined') {
              globalThis.BPBHealthChecker = new NodeHealthChecker();
              console.log('âœ… èŠ‚ç‚¹å¥åº·æ£€æŸ¥è¡¥ä¸å·²åŠ è½½');
            }
          })();
          // ====== è¡¥ä¸ç»“æŸ ======
          EOF
          
          # 2. å…³é”®æ­¥éª¤ï¼šç›´æ¥åˆå¹¶æ–‡ä»¶ï¼Œä¸æ··æ·†ï¼
          # å°†è¡¥ä¸æ”¾åœ¨æœ€å‰é¢ï¼Œç„¶åæ¥ä¸Šå®˜æ–¹ä»£ç 
          cat health_patch.js origin.js > _worker.js
          
          echo "ğŸ‰ æ³¨å…¥å®Œæˆï¼"
          echo "æœ€ç»ˆæ–‡ä»¶å¤§å°: $(wc -c < _worker.js) å­—èŠ‚"
          echo "æç¤ºï¼šå·²è·³è¿‡æ··æ·†æ­¥éª¤ï¼Œç›´æ¥è¾“å‡ºçº¯å‡€ä»£ç ä»¥ä¿è¯æœ€é«˜æ€§èƒ½ã€‚"

      - name: ğŸš€ æäº¤å¹¶è‡ªåŠ¨éƒ¨ç½²
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          branch: main
          commit_message: 'Update: éƒ¨ç½² å®˜æ–¹æœ€æ–°ç‰ˆ + å¥åº·è¡¥ä¸ (æ— æ··æ·†/é«˜æ€§èƒ½)'
          commit_author: 'github-actions[bot] <github-actions[bot]@users.noreply.github.com>'
          push_options: '--set-upstream'
