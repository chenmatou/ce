name: Build BPB Panel (Stable & Fast)

on:
  push:
    branches:
      - main
  schedule:
    # æ¯å¤©å‡Œæ™¨ 1:00 (UTC) è‡ªåŠ¨æ£€æŸ¥æ›´æ–°
    - cron: "0 1 * * *"
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨ç‚¹æŒ‰é’®è¿è¡Œ

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ä¸‹è½½æœ€æ–°ç‰ˆä»£ç  (è·³è¿‡æ··æ·†)
        run: |
          # å®šä¹‰ä¸Šæ¸¸ä»“åº“å’Œæ–‡ä»¶å
          REPO="bia-pain-bache/BPB-Worker-Panel"
          ASSET_NAME="worker.js"

          echo "ğŸš€ å¼€å§‹è·å–æœ€æ–°ç‰ˆæœ¬..."

          # 1. ä¼˜å…ˆå°è¯•ä» GitHub Release è·å–æœ€æ–°æ„å»ºç‰ˆ
          # Release ç‰ˆæœ¬é€šå¸¸æ˜¯ç»è¿‡æµ‹è¯•çš„ç¨³å®šç‰ˆ
          PRIMARY_URL=$(curl -s "https://api.github.com/repos/$REPO/releases/latest" \
            | grep "browser_download_url" \
            | grep "$ASSET_NAME" \
            | cut -d '"' -f 4)

          # 2. å¤‡ç”¨ä¸‹è½½åœ°å€ (ç›´æ¥æŒ‡å‘æºç ä»“åº“çš„æœªæ··æ·†æ–‡ä»¶)
          FALLBACK_URLS=(
            "https://raw.githubusercontent.com/bia-pain-bache/BPB-Worker-Panel/main/build/unobfuscated-worker.js"
            "https://cdn.jsdelivr.net/gh/bia-pain-bache/BPB-Worker-Panel@main/build/unobfuscated-worker.js"
          )

          # æ‰§è¡Œä¸‹è½½é€»è¾‘ï¼šç›´æ¥ä¿å­˜ä¸º _worker.js
          if [ -n "$PRIMARY_URL" ] && wget -O _worker.js "$PRIMARY_URL"; then
            echo "âœ… Release ç‰ˆæœ¬ä¸‹è½½æˆåŠŸï¼(æ¥æº: Release)"
          else
            echo "âš ï¸ Release è·å–å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨æºç åœ°å€..."
            SUCCESS=false
            for url in "${FALLBACK_URLS[@]}"; do
              if wget -O _worker.js "$url"; then
                echo "âœ… å¤‡ç”¨æºä¸‹è½½æˆåŠŸï¼(æ¥æº: $url)"
                SUCCESS=true
                break
              fi
            done
            
            # å¦‚æœæ‰€æœ‰åœ°å€éƒ½å¤±è´¥ï¼Œåˆ™æŠ¥é”™åœæ­¢
            if [ "$SUCCESS" = false ] || [ ! -s _worker.js ]; then
              echo "âŒ æ‰€æœ‰ä¸‹è½½æºå‡å¤±è´¥ï¼Œä»»åŠ¡ä¸­æ­¢ã€‚"
              exit 1
            fi
          fi

          echo "ğŸ‰ ä¸‹è½½å®Œæˆï¼æ–‡ä»¶å¤§å°: $(wc -c < _worker.js) å­—èŠ‚"
          echo "æç¤ºï¼šå·²è·³è¿‡æ‰€æœ‰æ··æ·†æ­¥éª¤ï¼Œä»¥ç¡®ä¿ Cloudflare Worker è¿è¡Œæœ€ç¨³å®šã€‚"

      - name: æäº¤å¹¶æ¨é€æ›´æ”¹
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          branch: main
          commit_message: 'Update: éƒ¨ç½²çº¯å‡€ç‰ˆ _worker.js (æ€§èƒ½ä¼˜åŒ–ç‰ˆ)'
          commit_author: 'github-actions[bot] <github-actions[bot]@users.noreply.github.com>'
          push_options: '--set-upstream'
