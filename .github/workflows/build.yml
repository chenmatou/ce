name: Build Stable BPB Panel

on:
  push:
    branches:
      - main
  schedule:
    - cron: "0 2 * * *" # 每天凌晨2点运行

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install obfuscator
        run: |
          npm init -y
          npm install javascript-obfuscator@4.1.0

      - name: Download BPB Stable Release
        run: |
          # 修复点：使用 jq 工具精确提取 JSON 中的 URL，自动去除所有空格和引号
          LATEST_URL=$(curl -s https://api.github.com/repos/bia-pain-bache/BPB-Worker-Panel/releases/latest | jq -r '.assets[] | select(.name=="worker.js") | .browser_download_url')
          
          # 打印清洗后的 URL 以便调试
          echo "Clean URL: '$LATEST_URL'"
          
          # 如果 API 获取失败（为空或为 null），则使用备用链接
          if [ -z "$LATEST_URL" ] || [ "$LATEST_URL" == "null" ]; then
             echo "Failed to fetch from API. Using fallback."
             # 这里的备用链接指向 v4.1.0 (根据你之前的日志)，你可以随时改为更新的版本号
             LATEST_URL="https://github.com/bia-pain-bache/BPB-Worker-Panel/releases/download/v4.1.0/worker.js"
          fi

          echo "Downloading from: $LATEST_URL"
          
          # -L 跟随重定向，-f 失败时不写入文件
          curl -fsSL "$LATEST_URL" -o origin.js

          # 验证文件是否存在且不为空
          if [ ! -s origin.js ]; then
            echo "Error: Download failed or file is empty."
            exit 1
          fi

      - name: Obfuscate (Performance Mode)
        run: |
          # 高稳定性混淆配置
          # 1. 移除 control-flow-flattening 防止 CPU 超时断流
          # 2. 移除 dead-code-injection 减小体积
          # 3. 启用 simplify 优化代码结构
          
          npx javascript-obfuscator origin.js \
            --output _worker.js \
            --compact true \
            --simplify true \
            --string-array true \
            --string-array-threshold 0.75 \
            --string-array-encoding 'base64' \
            --split-strings true \
            --rename-globals false \
            --identifier-names-generator hexadecimal \
            --target browser \
            --disable-console-output true

      - name: Verify Integrity
        run: |
          # 确保生成的文件大小合理 (Cloudflare 限制 1MB)
          SIZE=$(wc -c < _worker.js)
          echo "Final script size: $SIZE bytes"
          
          # 如果文件太小（小于10KB），说明生成失败
          if [ "$SIZE" -lt 10000 ]; then
            echo "Error: File too small, something went wrong."
            exit 1
          fi

      - name: Commit Result
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "build: stable optimized worker [skip ci]"
          file_pattern: "_worker.js"
