name: Cleanup and Fix BPB (Final)

on:
  push:
    branches:
      - main
  schedule:
    - cron: "0 1 * * *"
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è¿è¡Œ

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ—‘ï¸ æ¸…ç†æ—§çš„æ··æ·†åƒåœ¾æ–‡ä»¶
        run: |
          echo "å¼€å§‹æ¸…ç†æ—§ç‰ˆæœ¬çš„ä¸­é—´æ–‡ä»¶..."
          # åˆ é™¤ä¹‹å‰çš„ä¸‹è½½æºæ–‡ä»¶
          rm -f origin.js
          # åˆ é™¤ä¹‹å‰çš„ä¸€é˜¶æ®µæ··æ·†æ–‡ä»¶
          rm -f stage1.js
          echo "âœ… åƒåœ¾æ–‡ä»¶æ¸…ç†å®Œæ¯•"

      - name: ğŸ“¥ ä¸‹è½½å®˜æ–¹ Release çº¯å‡€ç‰ˆ
        run: |
          # è®¾å®šç›®æ ‡æ–‡ä»¶å
          TARGET_FILE="_worker.js"
          
          # å¼ºåˆ¶ä½¿ç”¨ GitHub Release çš„ä¸‹è½½é“¾æ¥ï¼ˆæœ€ç¨³å®šï¼Œæ— æ··æ·†ï¼‰
          DOWNLOAD_URL="https://github.com/bia-pain-bache/BPB-Worker-Panel/releases/latest/download/worker.js"

          echo "æ­£åœ¨ä¸‹è½½çº¯å‡€ç‰ˆ: $DOWNLOAD_URL"

          # ä¸‹è½½å¹¶è·Ÿéšé‡å®šå‘
          if wget -O temp_code.js -L "$DOWNLOAD_URL"; then
            echo "âœ… ä¸‹è½½æˆåŠŸ"
          else
            echo "âŒ ä¸‹è½½å¤±è´¥"
            exit 1
          fi

          # æ–‡ä»¶æ ¡éªŒï¼šé˜²æ­¢ä¸‹è½½åˆ°ç©ºæ–‡ä»¶æˆ–é”™è¯¯é¡µé¢
          FILE_SIZE=$(wc -c < temp_code.js)
          if [ "$FILE_SIZE" -lt 1000 ]; then
             echo "âŒ é”™è¯¯ï¼šæ–‡ä»¶è¿‡å°ï¼Œå¯èƒ½æ˜¯æ— æ•ˆæ–‡ä»¶ã€‚"
             rm temp_code.js
             exit 1
          fi

          # è¦†ç›–æ—§çš„æ··æ·†æ–‡ä»¶
          mv temp_code.js $TARGET_FILE
          echo "ğŸ‰ ä¿®å¤å®Œæˆï¼å½“å‰ _worker.js æ˜¯çº¯å‡€ç‰ˆ (å¤§å°: $FILE_SIZE å­—èŠ‚)"

      - name: ğŸš€ æäº¤æ›´æ”¹ (ä¿®å¤ç‰ˆ)
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          branch: main
          commit_message: 'Fix: æ¸…ç†æ··æ·†åƒåœ¾ + éƒ¨ç½²çº¯å‡€ç‰ˆ (è§£å†³æ— æ³•å¯¼å…¥é—®é¢˜)'
          commit_author: 'github-actions[bot] <github-actions[bot]@users.noreply.github.com>'
          push_options: '--set-upstream'
